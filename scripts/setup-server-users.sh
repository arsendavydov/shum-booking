#!/bin/bash
# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ğ´Ğ»Ñ K3s Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ

set -e

SERVER_IP="188.120.244.162"
ROOT_PASSWORD="XdeUuwHf_7ENZRH"

# Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¹
K3S_ADMIN_PASSWORD=$(openssl rand -base64 12 | tr -d "=+/" | cut -c1-16)
APP_USER_PASSWORD=$(openssl rand -base64 12 | tr -d "=+/" | cut -c1-16)

echo "ğŸ” Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ..."
echo ""

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
cat > /tmp/setup_users.sh << 'REMOTE_SCRIPT'
#!/bin/bash
set -e

# ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°ÑÑ‚ÑÑ ĞºĞ°Ğº Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
K3S_ADMIN_PASSWORD=$1
APP_USER_PASSWORD=$2

echo "ğŸ“‹ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹..."

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ K3s (k3s-admin)
if id "k3s-admin" &>/dev/null; then
    echo "âš ï¸  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ k3s-admin ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
else
    useradd -m -s /bin/bash k3s-admin
    echo "âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ k3s-admin ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
fi

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ k3s-admin
echo "k3s-admin:${K3S_ADMIN_PASSWORD}" | chpasswd

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ k3s-admin Ğ² sudo Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ
usermod -aG sudo k3s-admin
echo "âœ… k3s-admin Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ sudo"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (app-user)
if id "app-user" &>/dev/null; then
    echo "âš ï¸  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ app-user ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
else
    useradd -m -s /bin/bash app-user
    echo "âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ app-user ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
fi

# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ app-user
echo "app-user:${APP_USER_PASSWORD}" | chpasswd

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
mkdir -p /home/app-user/app
mkdir -p /home/app-user/.kube
chown -R app-user:app-user /home/app-user/app
chown -R app-user:app-user /home/app-user/.kube

echo "âœ… Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹"

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ SSH Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ - Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒĞ½ÑƒÑ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ)
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/PasswordAuthentication no/#PasswordAuthentication no/' /etc/ssh/sshd_config
systemctl reload sshd 2>/dev/null || service ssh reload 2>/dev/null || true

echo "âœ… SSH Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½"

# Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑÑ…
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "k3s-admin / ${K3S_ADMIN_PASSWORD}"
echo "app-user / ${APP_USER_PASSWORD}"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
REMOTE_SCRIPT

# ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€ Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ
if command -v sshpass >/dev/null 2>&1; then
    sshpass -p "$ROOT_PASSWORD" scp -o StrictHostKeyChecking=no /tmp/setup_users.sh root@${SERVER_IP}:/tmp/setup_users.sh
    sshpass -p "$ROOT_PASSWORD" ssh -o StrictHostKeyChecking=no root@${SERVER_IP} "chmod +x /tmp/setup_users.sh && /tmp/setup_users.sh '${K3S_ADMIN_PASSWORD}' '${APP_USER_PASSWORD}'"
else
    echo "âš ï¸  sshpass Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ:"
    echo ""
    echo "scp /tmp/setup_users.sh root@${SERVER_IP}:/tmp/"
    echo "ssh root@${SERVER_IP} 'chmod +x /tmp/setup_users.sh && /tmp/setup_users.sh \"${K3S_ADMIN_PASSWORD}\" \"${APP_USER_PASSWORD}\"'"
    echo ""
    echo "Ğ˜Ğ»Ğ¸ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ root Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸"
fi

# ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°
rm -f /tmp/setup_users.sh

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ Ğ£Ğ§Ğ•Ğ¢ĞĞ«Ğ• Ğ”ĞĞĞĞ«Ğ• ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ•Ğ™:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "k3s-admin / ${K3S_ADMIN_PASSWORD}"
echo "app-user / ${APP_USER_PASSWORD}"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:"
echo "   k3s-admin - Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ K3s (Ğ¸Ğ¼ĞµĞµÑ‚ sudo Ğ¿Ñ€Ğ°Ğ²Ğ°)"
echo "   app-user - Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ)"
echo ""

